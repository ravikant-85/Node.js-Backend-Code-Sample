name: Node CI
on:
    push:
        branches:
            - 'master'
jobs:
    main-build:
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/master'
        steps:
            - uses: actions/checkout@v3
              with:
                  ref: master
            - uses: up9cloud/action-rsync@master
              env:
                HOST: ${{ secrets.EC2_HOST}}
                TARGET: /var/www/
                PASSWORD: ${{ secrets.SSH_PASSWORD}}
                SOURCE: .
                USER: ${{ secrets.EC2_USER }}
            - name: executing remote ssh commands using password
              uses: appleboy/ssh-action@v1
              with:
                host: ${{ secrets.HOST }}
                username: linuxserver.io
                password: ${{ secrets.PASSWORD }}
                port: ${{ secrets.PORT }}
                script: |
                      export NVM_DIR=~/.nvm
                      source ~/.nvm/nvm.sh
                      cd /var/www/ ; npm install ; pm2 delete server ; pm2 start server.js ; pm2 save

