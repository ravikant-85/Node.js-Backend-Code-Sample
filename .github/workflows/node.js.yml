name: Node CI
on:
    push:
        branches:
            - 'master'
jobs:
    main-build:
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/master'
        steps:
            - uses: actions/checkout@v3
              with:
                  ref: master
            - name: Deploy to Server
              uses: easingthemes/ssh-deploy@main
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.PROD_AWS_KEY }}
                  ARGS: '-av'
                  SOURCE: './'
                  REMOTE_HOST: ${{ secrets.PROD_AWS_HOST }}
                  REMOTE_USER: ${{ secrets.PROD_AWS_USER }}
                  TARGET: '~/optalert/api/'
                  EXCLUDE: '/dist/, /node_modules/, .git/, /__mock__/, /__test__/, /docker/, /dockerfiles/'
            - name: Executing multiple commands
              uses: appleboy/ssh-action@v0.1.6
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_KEY }}
                  script: |
                      export NVM_DIR=~/.nvm
                      source ~/.nvm/nvm.sh
                      cd ~/opt/ ; npm install ; pm2 delete server ; pm2 start server.js ; pm2 save

